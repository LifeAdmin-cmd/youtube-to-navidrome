<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube to Navidrome</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background-color: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        
        .card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; box-sizing: border-box; border: 2px solid #eee; border-radius: 6px; font-size: 16px; }
        input[type="text"]:focus { border-color: #1db954; outline: none; }
        
        .btn-group { display: flex; gap: 10px; }
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        #startBtn { background-color: #1db954; }
        #startBtn:hover:not(:disabled) { background-color: #1ed760; }
        #cancelBtn { background-color: #dc3545; }
        #cancelBtn:hover:not(:disabled) { background-color: #c82333; }

        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 6px; margin: 25px 0 10px 0; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 20px; background-color: #1db954; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.5s ease; }

        .log-container { max-height: 200px; overflow-y: auto; border-top: 1px solid #eee; margin-top: 15px; font-size: 14px; }
        .log-entry { padding: 5px; border-bottom: 1px solid #f9f9f9; }
        .status-success { color: #155724; background-color: #d4edda; }
        .status-skipped { color: #856404; background-color: #fff3cd; }
        .status-error { color: #721c24; background-color: #f8d7da; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: 600; }
        .edit-btn { background-color: #007bff; padding: 6px 12px; font-size: 14px; width: auto; }
        .edit-btn:hover { background-color: #0056b3; }
        
        .row-skipped { background-color: #fffcf0; color: #856404; }
        /* Error row style (Red background) */
        .row-error { background-color: #ffe6e6; color: #a00; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .candidate-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .candidate-item:hover { background-color: #f1f1f1; }
        .candidate-img { width: 50px; height: 50px; margin-right: 15px; border-radius: 4px; object-fit: cover; }
        .candidate-info { flex-grow: 1; }
        .candidate-title { font-weight: bold; display: block; }
        .candidate-artist { font-size: 14px; color: #666; }
        .candidate-score { font-size: 12px; color: #1db954; float: right; }
        
        .modal-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .delete-btn { background-color: #dc3545; width: auto; padding: 8px 16px; }
        .delete-btn:hover { background-color: #c82333; }

    </style>
</head>
<body>

    <h1>YouTube to Navidrome</h1>

    <div class="card">
        <label for="url">Paste YouTube URL:</label>
        <input type="text" id="url" placeholder="https://www.youtube.com/..." required>
        
        <div class="btn-group">
            <button onclick="startProcess()" id="startBtn">Start Processing</button>
            <button onclick="cancelProcess()" id="cancelBtn" disabled>Cancel</button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div class="log-container" id="logContainer"></div>
    </div>

    <div class="card" id="resultsCard" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">Downloaded / Processed Tracks</h3>
            <button id="deleteAllFailedBtn" onclick="deleteAllFailed()" class="delete-btn" style="display:none; width: auto; font-size:14px; padding:6px 10px;">Delete All Failed</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>YouTube Title</th>
                    <th>Spotify Proposed</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
            </tbody>
        </table>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">×</span>
            <h3>Select Correct Track</h3>
            <div id="candidateList"></div>
            <div class="modal-footer">
                <button class="edit-btn" onclick="openRerunSearchModal()">Manual Tagging</button>
                <button class="delete-btn" onclick="deleteTrackFromModal()">Delete File</button>
            </div>
        </div>
    </div>
    
    <div id="rerunSearchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRerunSearchModal()">×</span>
            <h3>Rerun Spotify Search</h3>
            <p>Track: <span id="rerunTrackTitle" style="font-weight: bold;"></span></p>
            <p>Enter a custom search query or leave blank to use the original query: 
               <span id="originalQueryHint" style="font-style: italic; color: #666;"></span>
            </p>
            
            <input type="text" id="rerunQueryInput" placeholder="e.g. Artist - Title">
            <button class="edit-btn" id="rerunSearchBtn" onclick="submitRerunSearch()" style="width: 150px;">Search</button>
            
            <hr style="margin: 20px 0;">
            
            <h4 id="rerunCandidateHeader">Search Results</h4>
            <div id="rerunCandidateList">
                <p>Click 'Search' to get new results.</p>
            </div>
            
            <div class="modal-footer">
                <button class="delete-btn" onclick="closeRerunSearchModal()" style="background-color: #6c757d; width: 100px;">Close</button>
            </div>
        </div>
    </div>


    <script>
        let eventSource = null;
        let currentTrackUid = null;

        // NEW: Load failed tracks on page load
        document.addEventListener('DOMContentLoaded', loadFailedTracks);
        
        function loadFailedTracks() {
            fetch('/api/failed_tracks')
                .then(res => res.json())
                .then(data => {
                    const tracks = data.tracks;
                    if (tracks.length > 0) {
                        document.getElementById('resultsCard').style.display = "block";
                        
                        // Check for errors to show the delete button
                        const hasErrors = tracks.some(t => t.status === 'error');
                        if (hasErrors) {
                            document.getElementById('deleteAllFailedBtn').style.display = "block";
                        }

                        // Add a log message
                        const div = document.createElement('div');
                        div.className = `log-entry status-skipped`; // Use skipped styling as neutral warning
                        div.innerText = `Loaded ${tracks.length} previously failed tracks.`;
                        document.getElementById('logContainer').insertBefore(div, document.getElementById('logContainer').firstChild);

                        tracks.forEach(track => {
                            addResultRow(track);
                        });
                    }
                })
                .catch(err => console.error("Failed to load failed tracks:", err));
        }

        function startProcess() {
            const url = document.getElementById('url').value;
            if (!url) return alert("Please enter a URL");

            document.getElementById('startBtn').disabled = true;
            document.getElementById('cancelBtn').disabled = false;
            // Note: logContainer and resultsBody are NOT cleared here to preserve failed songs from the previous session
            document.getElementById('progressBar').style.width = "0%";
            document.getElementById('progressContainer').style.display = "block";
            document.getElementById('resultsCard').style.display = "block";

            if (eventSource) eventSource.close();
            eventSource = new EventSource(`/stream?url=${encodeURIComponent(url)}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.progress !== undefined) {
                    document.getElementById('progressBar').style.width = data.progress + "%";
                    document.getElementById('progressBar').innerText = data.progress + "%";
                }

                if (data.message) {
                    const div = document.createElement('div');
                    div.className = `log-entry status-${data.status}`;
                    div.innerText = data.message;
                    const lc = document.getElementById('logContainer');
                    lc.insertBefore(div, lc.firstChild);
                }
                
                // Show delete all button if a new error occurs
                if (data.status === 'error') {
                    document.getElementById('deleteAllFailedBtn').style.display = "block";
                }

                // Add row to table for success, skipped, OR error
                if (["success", "skipped", "error"].includes(data.status)) {
                    // Only add if we have track_uid (which error/skipped/success messages should have)
                    if (data.track_uid) {
                        // Only add success rows if they don't exist (i.e., immediately after process), 
                        // as they will be removed on next reload by loadFailedTracks() logic.
                        if (data.status !== "success" || !document.getElementById(`row-${data.track_uid}`)) {
                            addResultRow(data);
                        }
                        
                        // NEW: If a track goes from error/skipped (already in table) to success, remove it from the live table
                        if (data.status === "success" && document.getElementById(`row-${data.track_uid}`)) {
                            document.getElementById(`row-${data.track_uid}`).remove();
                        }
                    }
                }

                if (["finished", "fatal_error", "cancelled"].includes(data.status)) {
                    stopEventStream();
                }
            };
            
            eventSource.onerror = stopEventStream;
        }

        function addResultRow(data) {
            const tbody = document.getElementById('resultsBody');
            
            // Avoid duplicates if multiple messages sent for same ID
            if(document.getElementById(`row-${data.track_uid}`)) return;

            const tr = document.createElement('tr');
            tr.id = `row-${data.track_uid}`;
            
            if(data.status === 'skipped') {
                tr.className = 'row-skipped';
            } else if (data.status === 'error') {
                tr.className = 'row-error';
            }

            const statusLabel = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            const spotifyText = data.spotify_title ? `${data.spotify_artist} - ${data.spotify_title}` : 'No Match';

            tr.innerHTML = `
                <td>${data.youtube_title || 'Unknown'}</td>
                <td class="spotify-title">${spotifyText}</td>
                <td class="status-cell">${statusLabel}</td>
                <td><button class="edit-btn" onclick="openEditModal('${data.track_uid}')">Edit</button></td>
            `;
            tbody.appendChild(tr);
        }

        function displayCandidates(listElementId, candidates) {
            const list = document.getElementById(listElementId);
            list.innerHTML = "";
            if (!candidates || candidates.length === 0) {
                list.innerHTML = "<p>No candidates found.</p>";
                return;
            }
            candidates.forEach(c => {
                const div = document.createElement('div');
                div.className = 'candidate-item';
                div.onclick = () => selectCandidate(c.id);
                div.innerHTML = `
                    <img src="${c.image || ''}" class="candidate-img">
                    <div class="candidate-info">
                        <span class="candidate-title">${c.title}</span>
                        <span class="candidate-artist">${c.artist}</span>
                    </div>
                    <span class="candidate-score">${(c.score * 100).toFixed(0)}%</span>
                `;
                list.appendChild(div);
            });
        }

        function openEditModal(uid) {
            currentTrackUid = uid;
            document.getElementById('candidateList').innerHTML = "<p>Loading candidates...</p>";
            document.getElementById('editModal').style.display = "block";

            fetch(`/api/candidates/${uid}`)
                .then(res => res.json())
                .then(data => {
                    displayCandidates('candidateList', data.candidates);
                });
        }
        
        function openRerunSearchModal() {
            // Close the main edit modal
            document.getElementById('editModal').style.display = "none";
            
            const trackTitleSpan = document.getElementById('rerunTrackTitle');
            const queryHintSpan = document.getElementById('originalQueryHint');
            const rerunInput = document.getElementById('rerunQueryInput');
            
            // Clear results and enable button
            document.getElementById('rerunCandidateList').innerHTML = "<p>Click 'Search' to get new results.</p>";
            document.getElementById('rerunCandidateHeader').innerText = "Search Results";
            document.getElementById('rerunSearchBtn').disabled = false;

            // Fetch info for the modal
            fetch(`/api/candidates/${currentTrackUid}`)
                .then(res => res.json())
                .then(data => {
                    trackTitleSpan.innerText = data.youtube_title;
                    queryHintSpan.innerText = data.original_query;
                    
                    // Pre-fill the input with the original query and select it for easy overwriting
                    rerunInput.value = data.original_query;
                    rerunInput.select(); 

                    document.getElementById('rerunSearchModal').style.display = "block";
                })
                .catch(err => {
                    alert("Failed to load track info for rerun: " + err);
                    closeRerunSearchModal();
                });
        }
        
        function submitRerunSearch() {
            const query = document.getElementById('rerunQueryInput').value;
            const uid = currentTrackUid;

            if (!uid) return;
            
            document.getElementById('rerunSearchBtn').disabled = true;
            document.getElementById('rerunCandidateList').innerHTML = "<p>Searching Spotify...</p>";

            fetch(`/api/rerun_search/${uid}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('rerunSearchBtn').disabled = false;
                
                if(data.status === 'ok') {
                    const result = data.result;
                    document.getElementById('rerunCandidateHeader').innerText = `Search Results (Query: ${result.query_used})`;
                    displayCandidates('rerunCandidateList', result.candidates);

                } else {
                    document.getElementById('rerunCandidateList').innerHTML = `<p>Error: ${data.message}</p>`;
                }
            })
            .catch(err => {
                document.getElementById('rerunSearchBtn').disabled = false;
                document.getElementById('rerunCandidateList').innerHTML = `<p>Request failed: ${err}</p>`;
            });
        }

        function closeModal() {
            document.getElementById('editModal').style.display = "none";
            document.getElementById('rerunSearchModal').style.display = "none";
        }
        
        function closeRerunSearchModal() {
            document.getElementById('rerunSearchModal').style.display = "none";
        }

        function selectCandidate(spotifyId) {
            if(!confirm("Process file with this metadata? This may trigger a re-download.")) return;
            
            // Indicate processing in both modals in case user is in rerun modal
            document.getElementById('candidateList').innerHTML = "<p>Processing... Please wait.</p>";
            const rerunList = document.getElementById('rerunCandidateList');
            if (rerunList) rerunList.innerHTML = "<p>Processing... Please wait.</p>";


            fetch('/api/update_tag', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ track_uid: currentTrackUid, spotify_id: spotifyId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'ok') {
                    const row = document.getElementById(`row-${currentTrackUid}`);
                    
                    // Remove the row from the table when a failed/skipped track is successfully re-tagged
                    if (row) row.remove();
                    
                    closeModal();
                    alert(`Success! Saved as: ${data.result.new_filename}`);
                } else {
                    alert("Error: " + data.message);
                    closeModal();
                }
            })
            .catch(err => {
                alert("Request failed: " + err);
                closeModal();
            });
        }
        
        function deleteTrackFromModal() {
            if (!currentTrackUid) return;
            if (!confirm("Are you sure you want to delete this file? This cannot be undone.")) return;

            fetch('/api/delete_track', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ track_uid: currentTrackUid })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Remove the row from the table
                    const row = document.getElementById(`row-${currentTrackUid}`);
                    if (row) row.remove();
                    
                    closeModal();
                    alert("File deleted successfully.");
                } else {
                    alert("Error deleting file: " + data.message);
                }
            })
            .catch(err => {
                alert("Delete request failed: " + err);
            });
        }

        function deleteAllFailed() {
            if (!confirm("Are you sure you want to delete all failed tracks?")) return;
            
            fetch('/api/delete_all_failed', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    alert(`Deleted ${data.count} failed tracks.`);
                    // Remove all error rows from the table
                    const rows = document.querySelectorAll('.row-error');
                    rows.forEach(row => row.remove());
                    // Hide the button
                    document.getElementById('deleteAllFailedBtn').style.display = "none";
                } else {
                    alert("Error: " + data.message);
                }
            })
            .catch(err => {
                alert("Request failed: " + err);
            });
        }
        
        window.onclick = function(event) {
            if (event.target == document.getElementById('editModal')) closeModal();
            if (event.target == document.getElementById('rerunSearchModal')) closeRerunSearchModal();
        }

        function cancelProcess() {
            fetch('/cancel', { method: 'POST' });
        }

        function stopEventStream() {
            if (eventSource) { eventSource.close(); eventSource = null; }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('cancelBtn').disabled = true;
        }
    </script>

</body>
</html>